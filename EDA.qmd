
---
title: "Exploratory Data Analysis"
author: "Owen Simon"
format: 
  html:
    toc: true
    toc-depth: 3
    toc-location: left
    toc-title: "Contents"
    embed-resources: true
execute:
  include: true
  eval: true    
  warning: false
  message: false
---

# Buisness Problem

Many potential borrowers lack sufficient credit histories, making it difficult for Home Credit to accurately assess their creditworthiness. This creates a challenge in extending loans to unbanked individuals while managing default risk. To continue expanding financial inclusion responsibly, Home Credit must rely on alternative data to assess repayment risk for these applicants.

```{r}
# Load libraries
library(tidyverse)
library(tidyr)
library(dplyr)
library(gt)

data_dir <- "data-files"

# Read primary datasets
train <- read_csv(file.path(data_dir, "application_train.csv"))
test  <- read_csv(file.path(data_dir, "application_test.csv"))
```

# 1 - Majority Class Analysis

```{r}
target_proportion <- train |>
  count(TARGET) |>
  mutate(Proportion = round(n / sum(n), 4)) |>
  rename(
    Default = TARGET,
    Count = n
  )

gt(target_proportion)
```

A majority-class model that always predicts non-default would achieve an accuracy of approximately 92%.

# 2 - Correlation Analysis

## 2.1 - Numeric Variables

```{r}
# Select Numeric Variables
numeric_vars <- train |> select(where(is.numeric)) |>
	select(-TARGET) |> 
	names()

# Calculate Correlation with Target
numeric_summary <- lapply(numeric_vars, function(x) {
  data.frame(
    Predictor = x,
    Correlation_with_Target = cor(train[[x]], train$TARGET, use = "complete.obs")
  )
}) |> bind_rows()

# Rank by absolute correlation
numeric_summary <- numeric_summary |> 
	arrange(desc(abs(Correlation_with_Target)))

gt(numeric_summary)
```

## 2.2 - Categorical Variables

```{r}
# Convert character columns to factors
train_factored <- train |>
  mutate(across(where(is.character), as.factor))

categorical_vars <- train_factored |> select(where(is.factor)) |> names()

categorical_summary <- lapply(categorical_vars, function(var) {
  # calculate max proportion difference between target classes for each category
  prop_diff <- train_factored |>
    group_by(.data[[var]], TARGET) |>
    summarise(n = n(), .groups = "drop") |>
    pivot_wider(names_from = TARGET, values_from = n, values_fill = 0) |>
    mutate(
      Total = `0` + `1`,
      Proportion_0 = `0` / Total,
      Proportion_1 = `1` / Total,
      Difference = abs(Proportion_1 - Proportion_0)
    )
  
  # return a data frame with max difference for this variable
  data.frame(
    Predictor = var,
    Max_Proportion_Diff = max(prop_diff$Difference, na.rm = TRUE)
  )
}) |> bind_rows()

# Rank by largest difference
categorical_summary <- categorical_summary |> 
    arrange(desc(Max_Proportion_Diff))

gt(categorical_summary)
```

```{r}
# Add a placeholder SalePrice to test
test <- test |> 
  mutate(TARGET = NA)

# Combine train and test
combined <- bind_rows(
  train |> mutate(dataset = "train"),
  test  |> mutate(dataset = "test")
)
```

```{r}
#count NAs
count_missings <- function(x) sum(is.na(x))

missing_summary <- combined |>
  summarize_all(count_missings) |>
  pivot_longer(cols = everything(),
               names_to = "column",
               values_to = "missing") |>
  filter(missing > 0)

gt(missing_summary)
```